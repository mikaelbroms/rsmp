#!/usr/bin/env ruby
# Note: the shebang above expects ruby to be intalled through rbenv
#
# Executable wrapper for starting an RSMP supervisor (server)
# Expect a settings files to be present at config/supervisor.yaml

require_relative 'supervisor'
require 'optparse'

dir = File.dirname(__FILE__)
options = {
	supervisor_settings: {}
}

options_parser = OptionParser.new do |opts|
  opts.banner = "Usage: supervisor [options]"
  
  opts.on("-p PORT", "--port P", Integer, "Listen on port P") do |port|
    options[:supervisor_settings][:port] = port
  end
  
  opts.on('-i ID', '--site-id ID', 'Use site id ID') do |id|
    options[:supervisor_settings][:site_id] = id
  end
  
  opts.on('-s ID', '--sites ID', 'Allow sites with ID,...') do |list|
    list = list.split ','
    list.each do |id|
      options[:sites_settings] = [] unless options[:sites_settings]
      options[:sites_settings] << {"site_id"=>id}
    end
  end

  opts.on('-c CONFIG', '--config PATH', 'Path to .yaml config file') do |path|
    options[:supervisor_settings_path] = path
  end
  
  opts.on( '-h', '--help', 'Show help' ) do
    puts opts
    exit
  end
end

begin
	options_parser.parse!
rescue OptionParser::ParseError => e
    puts e
    puts options_parser
    exit 1
end

supervisor = RSMP::Supervisor.new(options)
supervisor.start

